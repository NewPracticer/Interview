### 场景方案

#### 电商场景方案 
+ 电商场景特点
    1. CA 要求高，P也有要求
+ 架构
    + 流量入口
        1. H5 -(访问静态资源)-> CDN -(回源)-> nginx静态资源站服务器 -> 磁盘文件
        2. -(访问动态请求)-> CDN  -(公网IP)-> LVS
        3. --> nginx反向代理服务器
    + 服务治理
        1. nacos 
        2. 商品服务(Springboot),交易服务（Springboot）
    + 数据选型
        1. mysql ,es，Redis
    + 领域模型
        + 商品的领域模型
            + 商品基础模型（商品id,商品名，商家id）
            + 商品主信息
                1. 运费模型，包邮，运费计算
                2. 类目模型，类目id，类目树
                3. 品牌模型，品牌id，品牌名
            + 商品交易信息
                1. 销售模型，销售数量
                2. 库存模型，库存数量，分仓
            + 价格模型，价格计价，价格类型
            + 详情模型，详情内容
        +  交易的领域模型（下单支付）
            + 业务单 （订单id,订单内容，金额）
            + 主子商品单 （业务子单，子单id，商品id，商品数量，金额）
            + 支付单 （支付单id，支付工具类型，金额）
            + 营销工具 (营销工具单，优惠券id，活动id，金额) 
    + 业务流程
        + 商品服务
            + 查询商品主信息 -> redis 
               1. 商家后台更新商品信息到mysql，同时异步更新redis 缓存
            + 查询商品交易信息  -> redis 
               1. 交易系统发生交易时，库存/销量更新到队列，同时队列异步更新到redis 
        + 交易系统 
+ 减库存
   + 压力点
      1. 不希望每次减库存操作都写DB
      2. 不希望每次读取库存都通过DB
   + 方案( [服务无状态](https://www.redhat.com/zh/topics/cloud-native-apps/stateful-vs-stateless)，批量写入，最终一致性)
      1. 库存服务
      2. Redis(key/value)库存
      3. 库存变更记录（Worker）
      4. 更新库存DB 
+ 秒杀 
   + 特点
      1. 瞬时流量大
      2. 读多写少
      3. 实时性要求高
   + 难点
      1. 减少DB命中：缓存，缓冲
      2. 需要反欺诈 
      3. 需要削峰： MQ消息队列
      4. 缓存一致性的实现：例如预减库存，用户下单后保留一段时间，然后释放
+ 下单、支付
   + 难点
        + 订单表通常很大 —> 水平拆分
        + 订单需要支持的业务非常多
            1. 订单状态变化（状态机）需要的资源较多
            2. 订单表访问非常频繁
            3. 需要通知的业务方很多
   + 策略
       1. 缓冲
       2. 缓冲设计
       3. 最终一致性
   + 方案
       1. 下单
           1. Redis订单（userid/order）
               1. 订单状态机
                    1. DB
           1. 订单队列
               1. DB
+ 缓存
   1. 端缓存
   2. 代理缓存
   3. CDN
   4. 分布式缓存
+ 单元化技术
   1. 多活
      1. 两地三中心：生产、同城灾备、异地灾备。  
   2. 灾备的处理方案
      1. 降级
      2. 限流
      3. 切流量     
    
   
        